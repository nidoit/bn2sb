#!/bin/bash
# Blunux Install Script
# Launches archinstall in a terminal for easy system installation

GREEN='\033[1;32m'
RED='\033[1;31m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
RESET='\033[0m'

echo ""
echo -e "${BLUE}======================================${RESET}"
echo -e "${BLUE}       Blunux System Installer${RESET}"
echo -e "${BLUE}======================================${RESET}"
echo ""

step1_ok=false
step2_ok=false
step3_ok=false

# ─────────────────────────────────────
# Step 1: Pacman 키링 초기화 대기
# ─────────────────────────────────────
echo -e "[1/3] ${YELLOW}Pacman 키링 초기화 대기 중...${RESET}"
sudo systemctl start pacman-init.service 2>/dev/null

for i in $(seq 1 120); do
    if [ -d /etc/pacman.d/gnupg/private-keys-v1.d ]; then
        step1_ok=true
        break
    fi
    sleep 1
    printf "\r      %d초 대기 중..." "$i"
done
echo ""

if [ "$step1_ok" = true ]; then
    echo -e "      ${GREEN}[성공]${RESET} Pacman 키링 초기화 완료"
else
    echo -e "      ${RED}[실패]${RESET} Pacman 키링 초기화 시간 초과 (120초)"
fi

# ─────────────────────────────────────
# Step 2: 미러리스트 확인
# ─────────────────────────────────────
echo ""
echo -e "[2/3] ${YELLOW}미러리스트 확인 중...${RESET}"

if grep -q "^Server" /etc/pacman.d/mirrorlist 2>/dev/null; then
    step2_ok=true
    echo -e "      ${GREEN}[성공]${RESET} 미러리스트가 이미 설정되어 있습니다"
else
    echo "      미러리스트가 비어있습니다. 기본 미러를 설정합니다..."
    sudo bash -c 'cat > /etc/pacman.d/mirrorlist << EOF
## Worldwide
Server = https://geo.mirror.pkgbuild.com/\$repo/os/\$arch
## Worldwide (Rackspace)
Server = https://mirror.rackspace.com/archlinux/\$repo/os/\$arch
## South Korea
Server = https://mirror.premi.st/archlinux/\$repo/os/\$arch
Server = https://ftp.lanet.kr/pub/archlinux/\$repo/os/\$arch
## Japan
Server = https://ftp.jaist.ac.jp/pub/Linux/ArchLinux/\$repo/os/\$arch
## United States
Server = https://mirrors.kernel.org/archlinux/\$repo/os/\$arch
EOF'
    if grep -q "^Server" /etc/pacman.d/mirrorlist 2>/dev/null; then
        step2_ok=true
        echo -e "      ${GREEN}[성공]${RESET} 기본 미러 설정 완료"
    else
        echo -e "      ${RED}[실패]${RESET} 미러리스트 설정 실패"
    fi
fi

# ─────────────────────────────────────
# Step 3: 패키지 데이터베이스 동기화
# ─────────────────────────────────────
echo ""
echo -e "[3/3] ${YELLOW}패키지 데이터베이스 동기화 중...${RESET}"

if sudo pacman -Sy --noconfirm 2>/dev/null; then
    step3_ok=true
    echo -e "      ${GREEN}[성공]${RESET} 패키지 데이터베이스 동기화 완료"
else
    echo -e "      ${RED}[실패]${RESET} 패키지 데이터베이스 동기화 실패"
fi

# ─────────────────────────────────────
# 결과 요약
# ─────────────────────────────────────
echo ""
echo -e "${BLUE}──────── 준비 결과 ────────${RESET}"
if [ "$step1_ok" = true ]; then
    echo -e "  1. 키링 초기화    ${GREEN}[OK]${RESET}"
else
    echo -e "  1. 키링 초기화    ${RED}[FAIL]${RESET}"
fi
if [ "$step2_ok" = true ]; then
    echo -e "  2. 미러리스트     ${GREEN}[OK]${RESET}"
else
    echo -e "  2. 미러리스트     ${RED}[FAIL]${RESET}"
fi
if [ "$step3_ok" = true ]; then
    echo -e "  3. DB 동기화      ${GREEN}[OK]${RESET}"
else
    echo -e "  3. DB 동기화      ${RED}[FAIL]${RESET}"
fi
echo -e "${BLUE}───────────────────────────${RESET}"

# 실패한 단계가 있으면 안내 후 종료
if [ "$step1_ok" = false ] || [ "$step2_ok" = false ] || [ "$step3_ok" = false ]; then
    echo ""
    echo -e "${RED}일부 단계가 실패했습니다.${RESET}"
    echo ""
    echo "  해결 방법:"
    echo "    - 인터넷 연결 확인: nmtui 실행 (WiFi) 또는 유선 연결 확인"
    echo "    - 연결 후 다시 실행: bash /usr/local/bin/blunux-install"
    echo ""
    read -p "그래도 설치를 계속하시겠습니까? (y/N): " choice
    if [[ ! "$choice" =~ ^[Yy]$ ]]; then
        echo "설치를 취소합니다."
        exit 1
    fi
fi

echo ""
echo -e "${GREEN}archinstall을 시작합니다...${RESET}"
echo ""

sudo archinstall
